#include "WiFi.h"
#include <ThingerESP32.h>
#include <DHT.h>

// ===============================
// CREDENCIALES THINGER
// ===============================
#define usuario "Maria_Correa"
#define device_Id "humedad"
#define device_credentials "Cd0Yw-VxSJT+!ntY"

ThingerESP32 thing(usuario, device_Id, device_credentials);

// ===============================
// WIFI
// ===============================
const char WiFi_ssid[] = "SERVOMECANISMOS";
const char WiFi_password[] = "servos2025";

// ===============================
// DHT11
// ===============================
#define DHT_PIN 16
#define DHT_TYPE DHT11

DHT dht(DHT_PIN, DHT_TYPE);

// ===============================
// VARIABLES
// ===============================
float temperatura = 0;
float humedad = 0;
unsigned long last_send = 0;

// ===============================
// SETUP
// ===============================
void setup() {
  Serial.begin(115200);

  dht.begin();

  thing.add_wifi(WiFi_ssid, WiFi_password);

  // Widgets en Thinger
  thing["temperatura"] >> outputValue(temperatura);
  thing["humedad"] >> outputValue(humedad);
}

// ===============================
// LOOP
// ===============================
void loop() {
  thing.handle();  // ⚠️ SIEMPRE PRIMERO

  humedad = dht.readHumidity();
  temperatura = dht.readTemperature(); // °C

  if (isnan(humedad) || isnan(temperatura)) {
    Serial.println("Error al leer DHT11");
    return;
  }

  Serial.print("Temperatura: ");
  Serial.print(temperatura);
  Serial.println(" °C");

  Serial.print("Humedad: ");
  Serial.print(humedad);
  Serial.println(" %");

  // Enviar al bucket cada 2 segundos
  if (millis() - last_send > 2000) {
    last_send = millis();

    pson data;
    data["temperatura"] = temperatura;
    data["humedad"] = humedad;

    thing.write_bucket("datosDHT11", data);

    Serial.println("Datos enviados al bucket");
  }
}
